---
# tasks file for rabbitmq
- name: create rabbitmq
  k8s:
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: rabbitmq
        namespace: doosra-vpc

- name: Add rbac
  k8s:
    definition:
      kind: Role
      apiVersion: rbac.authorization.k8s.io/v1beta1
      metadata:
        name: rabbitmq
        namespace: doosra-vpc
      rules:
      - apiGroups: [""]
        resources: ["endpoints"]
        verbs: ["get"]

- name: Add rolebinding
  k8s:
    definition:
      kind: RoleBinding
      apiVersion: rbac.authorization.k8s.io/v1beta1
      metadata:
        name: rabbitmq
        namespace: doosra-vpc
      subjects:
      - kind: ServiceAccount
        name: rabbitmq
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: Role
        name: rabbitmq

- name: Add service
  k8s:
    definition:
      kind: Service
      apiVersion: v1
      metadata:
        namespace: doosra-vpc
        name: rabbitmq
        labels:
          app: rabbitmq
          type: LoadBalancer
      spec:
        type: ClusterIP
        ports:
         - name: http
           protocol: TCP
           port: 15672
           targetPort: 15672
         - name: amqp
           protocol: TCP
           port: 5672
           targetPort: 5672
        selector:
          app: rabbitmq

- name: Add configmap
  k8s:
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: rabbitmq-config
        namespace: doosra-vpc
      data:
        RABBIT_ENV_RABBITMQ_USER: "guest"
        RABBIT_ENV_RABBITMQ_PASSWORD: "guest"
        enabled_plugins: |
            [rabbitmq_management,rabbitmq_peer_discovery_k8s].

        rabbitmq.conf: |
            ## Cluster formation. See http://www.rabbitmq.com/cluster-formation.html to learn more.
            cluster_formation.peer_discovery_backend  = rabbit_peer_discovery_k8s
            cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
            ## Should RabbitMQ node name be computed from the pod's hostname or IP address?
            ## IP addresses are not stable, so using [stable] hostnames is recommended when possible.
            ## Set to "hostname" to use pod hostnames.
            ## When this value is changed, so should the variable used to set the RABBITMQ_NODENAME
            ## environment variable.
            cluster_formation.k8s.address_type = ip
            ## How often should node cleanup checks run?
            cluster_formation.node_cleanup.interval = 30
            ## Set to false if automatic removal of unknown/absent nodes
            ## is desired. This can be dangerous, see
            ##  * http://www.rabbitmq.com/cluster-formation.html#node-health-checks-and-cleanup
            ##  * https://groups.google.com/forum/#!msg/rabbitmq-users/wuOfzEywHXo/k8z_HWIkBgAJ
            cluster_formation.node_cleanup.only_log_warning = true
            cluster_partition_handling = autoheal
            ## See http://www.rabbitmq.com/ha.html#master-migration-data-locality
            queue_master_locator=min-masters
            ## See http://www.rabbitmq.com/access-control.html#loopback-users
            loopback_users.guest = false
- name: add secrets
  k8s:
    definition:
      apiVersion: v1
      data:
        .dockercfg: eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJhc3dhZHdjIiwicGFzc3dvcmQiOiJuZXRvcmNhZ2VudEB3YW5jbG91ZHMjbmV0b3JjIiwiZW1haWwiOiJhc3dhZEB3YW5jbG91ZHMubmV0IiwiYXV0aCI6IllYTjNZV1IzWXpwdVpYUnZjbU5oWjJWdWRFQjNZVzVqYkc5MVpITWpibVYwYjNKaiJ9fQ==
      kind: Secret
      metadata:
        creationTimestamp: 2018-01-02T09:48:18Z
        name: docker-hub-secret
        namespace: doosra-vpc
        resourceVersion: "1863026"
        selfLink: /api/v1/namespaces/doosra-vpc/secrets/docker-hub-secret
        uid: 0fc221e0-efa2-11e7-b806-6248ff66fd54
      type: kubernetes.io/dockercfg

- name: Add sts
  k8s:
    definition:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: rabbitmq
        namespace: doosra-vpc
      spec:
        serviceName: rabbitmq
        replicas: 3
        selector:
          matchLabels:
            app: rabbitmq
        template:
          metadata:
            labels:
              app: rabbitmq
          spec:
            serviceAccountName: rabbitmq
            terminationGracePeriodSeconds: 10
            containers:
              - name: rabbitmq-autocluster
                image: wancloudsinc/rabbitmq
                ports:
                  - name: http
                    protocol: TCP
                    containerPort: 15672
                  - name: amqp
                    protocol: TCP
                    containerPort: 5672
                livenessProbe:
                  exec:
                    command: ["rabbitmqctl", "status"]
                  initialDelaySeconds: 30
                  timeoutSeconds: 5
                readinessProbe:
                  exec:
                    command: ["rabbitmqctl", "status"]
                  initialDelaySeconds: 10
                  timeoutSeconds: 5
                imagePullPolicy: Always
                env:
                  - name: MY_POD_IP
                    valueFrom:
                      fieldRef:
                        fieldPath: status.podIP
                  - name: RABBITMQ_USE_LONGNAME
                    value: "true"
                  - name: RABBITMQ_NODENAME
                    value: "rabbit@$(MY_POD_IP)"
                  - name: AUTOCLUSTER_TYPE
                    value: "k8s"
                  - name: AUTOCLUSTER_DELAY
                    value: "10"
                  - name: K8S_ADDRESS_TYPE
                    value: "ip"
                  - name: AUTOCLUSTER_CLEANUP
                    value: "true"
                  - name: CLEANUP_WARN_ONLY
                    value: "false"
            imagePullSecrets:
              - name: docker-hub-secret
